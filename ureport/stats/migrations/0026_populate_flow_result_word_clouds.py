# Generated by Django 3.2.8 on 2021-12-02 10:49


import time

from django.db import migrations


def noop(apps, schema_editor):  # pragma: no cover
    pass


def populate_flow_results_word_cloud(apps, schema_editor):  # pragma: no cover
    Org = apps.get_model("orgs", "Org")
    PollWordCloud = apps.get_model("stats", "PollWordCloud")

    start_time = time.time()
    orgs = Org.objects.all().order_by("id")
    count = 0

    for org in orgs:
        word_clouds = PollWordCloud.objects.filter(org=org).select_related("question", "flow_result")
        total = word_clouds.count()

        for word_cloud in word_clouds:
            if not word_cloud.flow_result:
                word_cloud.flow_result = word_cloud.question.flow_result
                word_cloud.save()
                count += 1

                elapsed = time.time() - start_time
                print(
                    f"Migrated flow_result for {count} of {total} polls word clouds on org #{org.id} in {elapsed:.1f} seconds"
                )

        print(f"Finished migrating polls word clouds on org #{org.id}")


def apply_manual():  # pragma: no cover
    from django.apps import apps

    populate_flow_results_word_cloud(apps, None)


class Migration(migrations.Migration):
    dependencies = [
        ("stats", "0025_more_indexes"),
    ]

    operations = [migrations.RunPython(populate_flow_results_word_cloud, noop)]
